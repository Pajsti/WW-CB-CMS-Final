---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const articles = await getCollection('news');
  return articles.map(article => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await article.render();

const fmtDate = (d: Date) => d.toLocaleDateString('cs-CZ', { year: 'numeric', month: 'long', day: 'numeric' });
const images = (article.data.images || []).map(i => i.src).filter(Boolean);
if (images.length === 0) images.push(article.data.image);
---

<Layout title={`${article.data.title} — WW-CB`}>
  <a href="/media" class="back" style="display:inline-block;margin-bottom:12px;color:var(--muted);text-decoration:none;font-weight:600">← Zpět na aktuality</a>

  <div class="article card">
    <h1>{article.data.title}</h1>
    <div class="meta muted">{fmtDate(article.data.date)}</div>

    <div class="content">
      <Content />
    </div>

    {images.length > 0 && (
      <div class="article-gallery" id="articleGallery">
        <div class="gallery-nav">
          <button class="gallery-btn" id="prevImg">&#8249;</button>
          <div class="gallery-main">
            <img id="galleryImg" src={images[0]} alt={article.data.title} style="cursor:pointer">
          </div>
          <button class="gallery-btn" id="nextImg">&#8250;</button>
        </div>
        <div class="gallery-counter" id="counter">1 / {images.length}</div>
        <div class="gallery-thumbs">
          {images.map((img, i) => (
            <img src={img} alt="" class={`thumb ${i === 0 ? 'active' : ''}`} data-index={i} style="cursor:pointer;opacity:0.6;transition:opacity 0.2s">
          ))}
        </div>
      </div>
    )}
  </div>

  <div id="fullscreenModal" class="fullscreen-modal" style="display:none;">
    <button id="closeModal" class="modal-close">&#215;</button>
    <button id="prevModal" class="modal-nav modal-prev">&#8249;</button>
    <img id="modalImg" src="" alt="">
    <button id="nextModal" class="modal-nav modal-next">&#8250;</button>
  </div>
</Layout>

<script define:vars={{ images }}>
  var currentIndex = 0;
  var galleryImg = document.getElementById('galleryImg');
  var counter = document.getElementById('counter');
  var thumbs = document.querySelectorAll('.thumb');
  var modal = document.getElementById('fullscreenModal');
  var modalImg = document.getElementById('modalImg');

  function updateGallery(index) {
    currentIndex = index;
    galleryImg.src = images[currentIndex];
    counter.textContent = (currentIndex + 1) + ' / ' + images.length;
    thumbs.forEach(function(t, i) {
      t.style.opacity = i === currentIndex ? '1' : '0.6';
      t.classList.toggle('active', i === currentIndex);
    });
  }

  document.getElementById('prevImg').onclick = function() { if (currentIndex > 0) updateGallery(currentIndex - 1); };
  document.getElementById('nextImg').onclick = function() { if (currentIndex < images.length - 1) updateGallery(currentIndex + 1); };
  thumbs.forEach(function(t, i) { t.onclick = function() { updateGallery(i); }; });

  galleryImg.onclick = function() { modalImg.src = images[currentIndex]; modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; };
  document.getElementById('closeModal').onclick = function() { modal.style.display = 'none'; document.body.style.overflow = ''; };
  document.getElementById('prevModal').onclick = function() { if (currentIndex > 0) { currentIndex--; modalImg.src = images[currentIndex]; } };
  document.getElementById('nextModal').onclick = function() { if (currentIndex < images.length - 1) { currentIndex++; modalImg.src = images[currentIndex]; } };
  modal.onclick = function(e) { if (e.target === modal) { modal.style.display = 'none'; document.body.style.overflow = ''; } };

  document.addEventListener('keydown', function(e) {
    if (modal.style.display === 'flex') {
      if (e.key === 'Escape') { modal.style.display = 'none'; document.body.style.overflow = ''; }
      if (e.key === 'ArrowLeft' && currentIndex > 0) { currentIndex--; modalImg.src = images[currentIndex]; }
      if (e.key === 'ArrowRight' && currentIndex < images.length - 1) { currentIndex++; modalImg.src = images[currentIndex]; }
    }
  });

  updateGallery(0);
</script>
