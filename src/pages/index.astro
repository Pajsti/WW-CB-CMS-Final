---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const articles = (await getCollection('news'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 5);

const fmtDate = (d: Date) => d.toLocaleDateString('cs-CZ', { year: 'numeric', month: 'short', day: 'numeric' });
---

<Layout title="WW-CB — Ahoj">
  <section class="hero">
    <div class="hero-left card">
      <div class="kicker" data-i18n="hero.kicker">Oficiální stránky</div>
      <h2 data-i18n="hero.title">Divoká voda — ČB</h2>
      <p class="muted" data-i18n="hero.lead">Aktuality, galerie, program a live výsledky.</p>

      <div class="features" role="list">
        <div class="feature-card card" role="listitem">
          <strong data-i18n="feat.news">Aktuality</strong>
          <div class="muted" data-i18n="feat.news-desc">Novinky, reporty a články z akcí.</div>
          <div style="margin-top:auto"><a href="/media" class="btn" data-i18n="feat.read">Číst</a></div>
        </div>
        <div class="feature-card card">
          <strong data-i18n="feat.gallery">Fotogalerie</strong>
          <div class="muted" data-i18n="feat.gallery-desc">Fotky ze závodů a tréninků.</div>
          <div style="margin-top:auto"><a href="/fotogalerie" class="btn" data-i18n="feat.open">Otevřít</a></div>
        </div>
        <div class="feature-card card">
          <strong data-i18n="feat.schedule">Harmonogram</strong>
          <div class="muted" data-i18n="feat.schedule-desc">Program závodních dnů a startovní listiny.</div>
          <div style="margin-top:auto"><a href="/schedule" class="btn" data-i18n="feat.view">Zobrazit</a></div>
        </div>
      </div>
    </div>

    <aside class="card">
      <h3 data-i18n="aside.quick">Rychlé odkazy</h3>
      <div class="quicklist">
        <a href="/live-tv" data-i18n="aside.live">Live TV</a>
        <a href="/race-office" data-i18n="aside.race">Race Office</a>
        <a href="/official-documents" data-i18n="aside.docs">Oficiální dokumenty</a>
        <a href="/sponsors" data-i18n="aside.sponsors">Sponzoři</a>
      </div>
    </aside>
  </section>

  <section style="margin-top:20px" class="card">
    <h3 data-i18n="news.title">Nejnovější</h3>
    {articles.length > 0 ? (
      <div id="newsCarousel">
        <div class="news-carousel">
          {articles.map((art, i) => (
            <div class={`carousel-item ${i === 0 ? 'active' : ''}`} data-index={i}>
              <a href={`/article/${art.slug}`}>
                <img src={art.data.image} alt={art.data.title}>
                <div class="carousel-item-content">
                  <h3>{art.data.title}</h3>
                  <p>{art.data.excerpt}</p>
                  <div class="date-pill">{fmtDate(art.data.date)}</div>
                </div>
              </a>
            </div>
          ))}
        </div>
        <div class="carousel-dots">
          {articles.map((_, i) => (
            <div class={`dot ${i === 0 ? 'active' : ''}`} data-index={i}></div>
          ))}
        </div>
      </div>
    ) : (
      <div class="empty">Žádné články.</div>
    )}
  </section>
</Layout>

<script>
  var currentSlide = 0;
  var carouselInterval = null;
  var items = document.querySelectorAll('.carousel-item');
  var dots = document.querySelectorAll('.dot');

  function goToSlide(index) {
    if (!items[currentSlide]) return;
    items[currentSlide].classList.add('prev');
    items[currentSlide].classList.remove('active');
    var prev = currentSlide;
    setTimeout(function() { items[prev].classList.remove('prev'); }, 500);
    currentSlide = index;
    items[currentSlide].classList.add('active');
    dots.forEach(function(d, i) { d.classList.toggle('active', i === currentSlide); });
  }

  function startTimer() {
    if (carouselInterval) clearInterval(carouselInterval);
    if (items.length > 1) {
      carouselInterval = setInterval(function() {
        goToSlide((currentSlide + 1) % items.length);
      }, 5000);
    }
  }

  dots.forEach(function(dot) {
    dot.addEventListener('click', function() {
      goToSlide(parseInt(dot.dataset.index || '0'));
      startTimer();
    });
  });

  startTimer();

  document.addEventListener('visibilitychange', function() {
    if (document.hidden) { if (carouselInterval) clearInterval(carouselInterval); }
    else startTimer();
  });
</script>
